machine:
  node:
    version: 7.7.2

dependencies:
  override:
    - npm install
    - pip install -r requirements.txt

test:
  override:
    - npm test

deployment:
  release:
    tag: /v[0-9]+(\.[0-9]+)*/
    commands:
      - bash publish codesplain-lambda-functions/$CIRCLE_TAG
  master:
    branch: master
    commands:
      - echo $CI_PULL_REQUEST
      - echo $CI_PULL_REQUESTS
      - bash publish codesplain-lambda-functions/dev/$CIRCLE_SHA1
      - >
        aws cloudformation update-stack
        --stack-name CodesplainDev
        --parameters
        ParameterKey=S3Version,ParameterValue="dev/$CIRCLE_SHA1"
        --use-previous-template
        --region us-west-2
  feature:
    branch: /^((?!master).)*$/ # not master
    commands:
      - bash publish codesplain-lambda-functions/sandbox/$CIRCLE_BRANCH
      - >
        aws cloudformation package --template-file featureBranchDeploy.yaml
        --s3-bucket codesplain-lambda-functions
        --output-template-file serverless-output-sandbox.yaml
      - >
        aws cloudformation deploy
        --stack-name "CodesplainFeature-$CIRCLE_BRANCH"
        --template-file ./serverless-output-sandbox.yaml
        --parameter-overrides
        EnvVersion="$CIRCLE_BRANCH"
        S3Version="sandbox/$CIRCLE_BRANCH"
        ClientSecret="$AuthSecret"
        ClientID="$AuthId"
        Title="Codesplain Feature:$CIRCLE_BRANCH"
        --region us-west-2
